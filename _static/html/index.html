<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Crinit -- Configurable Rootfs Init: Crinit &ndash; Configurable Rootfs Init</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Crinit -- Configurable Rootfs Init
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Crinit &ndash; Configurable Rootfs Init </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> </p>
<h1><a class="anchor" id="table-of-contents"></a>
Table of Contents</h1>
<p><img src="images/crinit_logo_blu.svg" alt="" style="pointer-events: none;" width="20%" height="20%" align="right" class="inline"/></p>
<ul>
<li><a class="el" href="index.html#in-a-nutshell">In a Nutshell</a></li>
<li><a class="el" href="index.html#concept">Concept</a></li>
<li><a class="el" href="index.html#features">Features</a></li>
<li><a class="el" href="index.html#license">License</a></li>
<li><a class="el" href="index.html#powered-by-eb">Powered by EB</a></li>
<li><a class="el" href="index.html#maintainers">Maintainers</a></li>
<li><a class="el" href="index.html#credits">Credits</a></li>
<li><a class="el" href="index.html#artwork">Artwork</a></li>
<li><a class="el" href="index.html#command-line-options">Command-line options</a></li>
<li><a class="el" href="index.html#environment-variables">Environment Variables</a></li>
<li><a class="el" href="index.html#configuration">Configuration</a><ul>
<li><a class="el" href="index.html#example-global-configuration">Example Global Configuration</a><ul>
<li><a class="el" href="index.html#explanation">Explanation</a></li>
</ul>
</li>
<li><a class="el" href="index.html#example-task-configuration">Example Task Configuration</a><ul>
<li><a class="el" href="index.html#explanation-1">Explanation</a></li>
</ul>
</li>
<li><a class="el" href="index.html#setting-environment-variables">Setting Environment Variables</a></li>
<li><a class="el" href="index.html#defining-elos-filters">Defining Elos Filters</a><ul>
<li><a class="el" href="index.html#ruleset">Ruleset</a></li>
</ul>
</li>
<li><a class="el" href="index.html#include-files">Include files</a></li>
<li><a class="el" href="index.html#io-redirections">IO Redirections</a><ul>
<li><a class="el" href="index.html#named-pipes">Named pipes</a></li>
<li><a class="el" href="index.html#a-note-on-buffering">A note on buffering</a></li>
</ul>
</li>
<li><a class="el" href="index.html#dependency-groups-meta-tasks">Dependency groups (meta-tasks)</a></li>
<li><a class="el" href="index.html#configuration-signatures">Configuration Signatures</a></li>
</ul>
</li>
<li><a class="el" href="index.html#crinit-ctl-usage-info">crinit-ctl Usage Info</a></li>
<li><a class="el" href="index.html#smart-bash-completion-for-crinit-ctl">Smart bash completion for crinit-ctl</a></li>
<li><a class="el" href="index.html#crinit-launch">crinit-launch</a></li>
<li><a class="el" href="index.html#build-instructions">Build Instructions</a></li>
<li><a class="el" href="index.html#build-requirements">Build Requirements</a></li>
</ul>
<h1><a class="anchor" id="in-a-nutshell"></a>
In a Nutshell</h1>
<p>Crinit is an init daemon executed as PID 1 by the Linux Kernel. It reads a global configuration ("series"-file) either specified on the command line or from <code>/etc/crinit/default.series</code>. The series file in turn may reference further configuration files or a whole directory from which all configs shall be loaded. Each one defines a task potentially containing a set of commands and dependencies on other tasks.</p>
<p>The specified tasks are then started with as much parallelism as dependencies allow, i.e. tasks without any dependencies are spawned as soon as possible after Crinit has been started. Once a task is spawned, finished, or has failed, its dependent tasks are updated and spawned as necessary.</p>
<h1><a class="anchor" id="concept"></a>
Concept</h1>
<p>The below diagram shows the overall concept of Crinit.</p>
<div class="image">
<object type="image/svg+xml" data="rootfs_init_comp.svg" style="pointer-events: none;"></object>
<div class="caption">
Rootfs Init Daemon Components</div></div>
    <p>Not indicated in the diagram are planned cryptographic features of the Config Parser intended to provide optional verification/integrity checking of the global and task configurations.</p>
<h1><a class="anchor" id="features"></a>
Features</h1>
<p>Crinit currently has the following features implemented:</p>
<ul>
<li>starting of tasks with parallelism and dependency-resolution<ul>
<li>tasks may have one or multiple commands, or none to form a dependency group</li>
<li>dependencies can be either on specific task state changes or on "features" another (unknown) task will provide</li>
<li>timestamping of creation, start, and end times of a task</li>
</ul>
</li>
<li>a C client API and a command-line interface using it (<code>crinit-ctl</code>) capable of<ul>
<li>adding new tasks</li>
<li>managing (stop, kill, restart, ...) already loaded tasks</li>
<li>querying task status and timestamps</li>
<li>handling reboot and poweroff</li>
<li>a basic source-compatible implementation of <code><a class="el" href="crinit-client_8c.html#a4fefeba7a71824e0b7058c4f59b56dbc">sd_notify()</a></code></li>
</ul>
</li>
<li>task IO redirection (like shell pipes)<ul>
<li>to files, for example for basic logging purposes</li>
<li>to named pipes, to pipe output between tasks</li>
</ul>
</li>
<li>task environment variable management<ul>
<li>a global environment can be set</li>
<li>task-specific local settings can override and/or extend the global environment</li>
</ul>
</li>
<li>include files to maintain task configuration presets</li>
<li>optional integration with <a href="https://github.com/Elektrobit/elos">elos</a><ul>
<li>support for events sent by elos as task dependencies</li>
</ul>
</li>
<li>ability to report task state changes back to elos<ul>
<li>emits appropriate events when a task is created, starts, exits, or fails</li>
</ul>
</li>
<li>optional signature checking of Crinit's configuration files</li>
<li>setting of UID and GID a task should be run as</li>
</ul>
<p>In the future we also plan to support:</p>
<ul>
<li>fine-grained restriction of processes started/managed by Crinit<ul>
<li>capabilities, cgroups,...</li>
</ul>
</li>
</ul>
<p>There are example configurations below which show how to use the currently implemented features. For detailed explanations of Crinit's inner workings please refer to the Doxygen documentation generated during build. The client API is documented in the Doxygen documentation of <code><a class="el" href="crinit-client_8h.html" title="Public definitions/declarations for using the crinit-client shared library.">crinit-client.h</a></code>. The API is implemented as a shared library (<code>libcrinit-client.so</code>).</p>
<p>This repository also includes an example application to generate a <code>/etc/machine-id</code> file, which is used to uniquely identify the system (for example by <code>elosd</code>). The <code>machine-id-gen</code> tool is supposed to be called on boot, for example from <code>earlysetup.crinit</code> as shown in the example configuration files contained in this repository. Its implementation either uses the value for <code>systemd.machine_id</code> given on the Kernel command line or &ndash; on an NXP S32G-based board &ndash; the unique ID burned to on-chip OTP memory. If the Kernel command line value is set, it always takes precedence and any physical memory OTP reads are omitted. This means that while the application has special functionality for S32G SoCs, it can work on any target as long as the Kernel command line contains the necessary value.</p>
<h1><a class="anchor" id="license"></a>
License</h1>
<p>MIT License</p>
<p>Copyright (c) [2023] [emlix GmbH, Elektrobit Automotive GmbH]</p>
<p>The full text of the license can be found in the [LICENSE](LICENSE) file in the repository root directory.</p>
<h1><a class="anchor" id="powered-by-eb"></a>
Powered by EB</h1>
<p><img src="images/eb-logo.png" alt="" width="70" height="70" hspace="10" align="left" class="inline"/> Crinit is powered by Elektrobit Automotive GmbH.</p>
<p>Elektrobit is an automotive software company and developer of embedded software products for ECU, AUTOSAR, automated driving, connected vehicles and UX. Crinit is an integrated part of EB corbos Linux.</p>
<p>EB corbos Linux – built on Ubuntu - is an open-source operating system for high-performance computing, leveraging the rich functionality of Linux while meeting security and industry regulations.</p>
<h1><a class="anchor" id="maintainers"></a>
Maintainers</h1>
<ul>
<li>Andreas Zdziarstek <a href="#" onclick="location.href='mai'+'lto:'+'and'+'re'+'as.'+'zd'+'zia'+'rs'+'tek'+'@e'+'mli'+'x.'+'com'; return false;">andre<span class="obfuscator">.nosp@m.</span>as.z<span class="obfuscator">.nosp@m.</span>dziar<span class="obfuscator">.nosp@m.</span>stek<span class="obfuscator">.nosp@m.</span>@emli<span class="obfuscator">.nosp@m.</span>x.co<span class="obfuscator">.nosp@m.</span>m</a> <a href="https://github.com/gmcn42">@gmcn42</a></li>
<li>Thomas Brinker <a href="#" onclick="location.href='mai'+'lto:'+'tho'+'ma'+'s.b'+'ri'+'nke'+'r@'+'eml'+'ix'+'.co'+'m'; return false;">thoma<span class="obfuscator">.nosp@m.</span>s.br<span class="obfuscator">.nosp@m.</span>inker<span class="obfuscator">.nosp@m.</span>@eml<span class="obfuscator">.nosp@m.</span>ix.co<span class="obfuscator">.nosp@m.</span>m</a> <a href="https://github.com/ThomasBrinker">@ThomasBrinker</a></li>
</ul>
<h1><a class="anchor" id="credits"></a>
Credits</h1>
<ul>
<li>Andreas Schickedanz</li>
<li>Andreas Zdziarstek</li>
<li>Anja Lehwess-Litzmann</li>
<li>Annika Schmitt</li>
<li>Anton Hillebrand</li>
<li>Daniel Glöckner</li>
<li>Rainer Müller</li>
<li>Stefan Kral</li>
<li>Thomas Brinker</li>
<li>Wolfgang Gehrhardt</li>
</ul>
<h1><a class="anchor" id="artwork"></a>
Artwork</h1>
<p>The crinit logo is the Swallow (Hirundinidae). A quick and small bird able to fly long distances. Originator is Anja Lehwess-Litzmann (emlix GmbH). Year 2023. It is licensed under Creative Commons No Derivatives (CC-nd). It shall be used in black on white or HKS43 color.</p>
<h1><a class="anchor" id="command-line-options"></a>
Command-line options</h1>
<p>Crinit is mainly configured via global and task-specific configuration files. There are, however, some specific options related to its behavior as a secondary init process (e.g. if crinit is started by another init process, or even itself). These options can only be changed through command-line parameters.</p>
<p>Specifically, those are</p>
<ul>
<li><b>&ndash;sys-mounts/&ndash;no-sys-mounts</b> - Depending on the setting, Crinit will or will not mount some hardcoded system directories. Some of these are needed by Crinit itself to function. So, if deactivated, they need to be already mounted when Crinit starts. If activated, Crinit will mount<ul>
<li><code>/dev</code> - devtmpfs pseudo file system</li>
<li><code>/dev/pts</code> - devpts pseudo file system</li>
<li><code>/proc</code> - procfs filesystem, needed by Crinit to parse the Kernel cmdline</li>
<li><code>/run</code> - tmpfs, needed by Crinit to create its socket (default location)</li>
<li><code>/sys</code> - sysfs pseudo file system Default: Activated if Crinit is PID 1, otherwise deactivated.</li>
</ul>
</li>
<li><b>&ndash;child-subreaper/&ndash;no-child-subreaper</b> - Depending on the setting, Crinit will or will not provide a process with "child subreaper" process attribute (see <a href="https://man7.org/linux/man-pages/man2/PR_SET_CHILD_SUBREAPER.2const.html">PR_SET_CHILD_SUBREAPER manpage</a>). This is a relevant setting only if Crinit is not PID 1, i.e. started as a secondary init process. In that case, Crinit can use this setting to provide the "zombie reaper" function for its descendent processes. For example, this can be helpful in some containerization scenarios. If Crinit is PID 1, however, it will always provide a "zombie
    reaper" regardless of this setting. By default, Crinit will respect the attribute as it is set when Crinit is started and behave accordingly, i.e. if Crinit either is PID 1 or it has the CHILD_SUBREAPER process attribute, it will reap zombies of its descendants.</li>
</ul>
<h1><a class="anchor" id="environment-variables"></a>
Environment Variables</h1>
<p>Crinit also respects the environment variable</p><ul>
<li><code>CRINIT_SOCK</code> - The path to the socket file Crinit will create for communication through <code>libcrinit-client</code>. Default: <code>/run/crinit/crinit.sock</code></li>
</ul>
<p>Note that <code>crinit-ctl</code> uses the same environment variable to decide to which socket it will connect to. This makes it possible to have multiple instances of crinit running alongside each other, each controlled through a different socket.</p>
<h1><a class="anchor" id="configuration"></a>
Configuration</h1>
<p>As described above, Crinit needs a global series-file containing global configuration options as well as a list of task configurations. Examples for a local demonstration inside the build environment (see <a class="el" href="index.html#build-instructions">Build Instructions</a> below) are available in <code>config/test/</code> and examples to use as a starting point for a minimal system boot are available in <code>config/example/</code>.</p>
<p>The general format of crinit configuration files is INI-style <code>KEY = value</code> pairs. Some settings may be array-like, meaning they can be specified multiple times to append values. Leaving out the <code>KEY =</code> part at the start of the line in favor of at least one whitespace character is shorthand for appending to the last key, for example: </p><div class="fragment"><div class="line">ARRAY_LIKE_KEY = value 1</div>
<div class="line">ARRAY_LIKE_KEY = value 2</div>
</div><!-- fragment --><p> is equivalent to </p><div class="fragment"><div class="line">ARRAY_LIKE_KEY = value 1</div>
<div class="line">                 value 2</div>
</div><!-- fragment --><h2><a class="anchor" id="example-global-configuration"></a>
Example Global Configuration</h2>
<p>An example to boot a minimal environment may look like this: </p><div class="fragment"><div class="line"># Crinit global configuration file</div>
<div class="line"> </div>
<div class="line">TASKS = earlysetup.crinit check_qemu.crinit network-dhcp.crinit</div>
<div class="line">        sshd.crinit getty.crinit</div>
<div class="line"> </div>
<div class="line">TASKDIR = /etc/crinit</div>
<div class="line">TASK_FILE_SUFFIX = .crinit</div>
<div class="line">TASKDIR_FOLLOW_SYMLINKS = YES</div>
<div class="line">INCLUDEDIR = /etc/crinit</div>
<div class="line">INCLUDE_SUFFIX = .crincl</div>
<div class="line">DEBUG = NO</div>
<div class="line"> </div>
<div class="line">SHUTDOWN_GRACE_PERIOD_US = 100000</div>
<div class="line"> </div>
<div class="line">LAUNCHER_CMD = /usr/bin/crinit-launch</div>
<div class="line"> </div>
<div class="line">USE_SYSLOG = NO</div>
<div class="line">USE_ELOS = YES</div>
<div class="line"> </div>
<div class="line">ELOS_SERVER = 192.168.3.43</div>
<div class="line">ELOS_PORT = 2342</div>
<div class="line">ELOS_EVENT_POLL_INTERVAL = 250000</div>
<div class="line"> </div>
<div class="line">ENV_SET = FOO &quot;foo&quot;</div>
<div class="line">ENV_SET = FOO_BAZ &quot;${FOO} baz&quot;</div>
<div class="line">ENV_SET = GREETING &quot;Good morning!&quot;</div>
</div><!-- fragment --> <h3><a class="anchor" id="explanation"></a>
Explanation</h3>
<ul>
<li><b>TASKS</b> &ndash; The task configurations to load. This is an optional setting. If not set, <b>TASKDIR</b> will be scanned for task configuration files. (<em>array-like</em>)</li>
<li><b>TASKDIR</b> &ndash; Where to find the task configurations, will be prepended to the filenames in <b>TASKS</b>. Default: <code>/etc/crinit</code></li>
<li><b>TASK_FILE_SUFFIX</b> &ndash; Filename suffix of task configurations. Only relevant if <b>TASKS</b> is not set. Default: <code>.crinit</code></li>
<li><b>TASKDIR_FOLLOW_SYMLINKS</b> &ndash; If symbolic links should be followed during scanning of <b>TASKDIR</b>. Only relevant if <b>TASKS</b> is not set. Default: YES</li>
<li><b>INCLUDEDIR</b> &ndash; Where to find include files referenced from task configurations. Default: Same as <b>TASKDIR</b>.</li>
<li><b>INCLUDE_SUFFIX</b> &ndash; Filename suffix of include files referenced from task configurations. Default: <code>.crincl</code></li>
<li><b>DEBUG</b> &ndash; If crinit should be verbose in its output. Either <code>YES</code> or <code>NO</code>. Default: <code>NO</code></li>
<li><b>LAUNCHER_CMD</b> &ndash; Specify location of the crinit-launch binary. Optional. If not given, crinit-launch is taken from the default installation path. Needed to execute a <b>COMMAND</b> as a different user or group.</li>
<li><b>SHUTDOWN_GRACE_PERIOD_US</b> &ndash; The amount of microseconds to wait both between <code>STOP_COMMAND</code> and <code>SIGTERM</code> as well as between<code>SIGTERM</code> and <code>SIGKILL</code> on shutdown/reboot. Default: 100000</li>
<li><b>USE_SYSLOG</b> &ndash; If syslog should be used for output if it is available. If set to <code>YES</code>, Crinit will switch to syslog for output as soon as a task file <code>PROVIDES</code> the <code>syslog</code> feature. Ideally this should be a task file loading a syslog server such as syslogd or elosd. Default: <code>NO</code></li>
<li><b>USE_ELOS</b> &ndash; If Elos should be used as event based dependency provider if it is available. If set to <code>YES</code>, Crinit will allow Elos event filters as task dependencies with the <code>@elos</code> prefix as soon as a task file <code>PROVIDES</code> the <code>elos</code> feature. Ideally this should be a task file loading the Elos daemon elosd. Default is <code>NO</code>. Needs ELOS support included at build-time.</li>
<li><b>ELOS_SERVER</b> &ndash; Ip address of the elos server. Default: <code>127.0.0.1</code> Needs ELOS support included at build-time.</li>
<li><b>ELOS_PORT</b> &ndash; Port of the elos server. Default: <code>54321</code> Needs ELOS support included at build-time.</li>
<li><b>ELOS_EVENT_POLL_INTERVAL</b> &ndash; Interval in microseconds between polling requests for events from elos. This is a tradeoff between idle CPU use and latency of tasks depending on an elos event (see section <b>Defining Elos Filters</b> below). Default is 500000. Needs ELOS support included at build-time.</li>
<li><b>ENV_SET</b> &ndash; See section <b>Setting Environment Variables</b> below. (<em>array-like</em>)</li>
<li><b>FILTER_DEFINE</b> &ndash; See section <b>Defining Elos Filters</b> below. (<em>array-like</em>)</li>
</ul>
<h2><a class="anchor" id="example-task-configuration"></a>
Example Task Configuration</h2>
<p>The <code>network-dhcp.crinit</code> from above could for example look like this: </p><div class="fragment"><div class="line"># DHCP config for a minimal system</div>
<div class="line"> </div>
<div class="line">NAME = network-dhcp</div>
<div class="line"> </div>
<div class="line">INCLUDE = daemon_env_preset</div>
<div class="line"> </div>
<div class="line">COMMAND = /bin/mkdir -p /var/lib/dhcpcd</div>
<div class="line">          /bin/mount -t tmpfs none /var/lib/dhcpcd</div>
<div class="line">          /bin/touch /var/lib/dhcpcd/resolv.conf</div>
<div class="line">          /bin/mount -o bind /var/lib/dhcpcd/resolv.conf /etc/resolv.conf</div>
<div class="line">          /sbin/ifconfig lo up</div>
<div class="line">          /sbin/ifconfig lo 127.0.0.1</div>
<div class="line">          /sbin/dhcpcd -j /var/log/dhcpcd.log eth0</div>
<div class="line"> </div>
<div class="line">STOP_COMMAND = /sbin/ifconfig eth0 down</div>
<div class="line"> </div>
<div class="line">USER = root</div>
<div class="line">GROUP = root</div>
<div class="line"> </div>
<div class="line">DEPENDS = check_qemu:fail earlysetup:wait @provided:writable_var</div>
<div class="line"> </div>
<div class="line">PROVIDES = ipv4_dhcp:wait resolvconf:wait</div>
<div class="line"> </div>
<div class="line">RESPAWN = NO</div>
<div class="line">RESPAWN_RETRIES = -1</div>
<div class="line"> </div>
<div class="line">ENV_SET = FOO_BAR &quot;${FOO} bar&quot;</div>
<div class="line">          ESCAPED_VAR &quot;Global variable name: \${FOO}&quot;</div>
<div class="line">          VAR_WITH_ESC_SEQUENCES &quot;hex\t\x68\x65\x78&quot;</div>
<div class="line">          GREETING &quot;Good evening!&quot;</div>
<div class="line"> </div>
<div class="line">IO_REDIRECT = STDOUT &quot;/var/log/net-dhcp.log&quot; APPEND 0644</div>
<div class="line">IO_REDIRECT = STDERR STDOUT</div>
</div><!-- fragment --> <h3><a class="anchor" id="explanation-1"></a>
Explanation</h3>
<ul>
<li><b>NAME</b> &ndash; The name given to this task configuration. Relevant if other tasks want to depend on this one. This is a mandatory setting.</li>
<li><b>INCLUDE</b> &ndash; See section <b>Include files</b> below. (<em>array-like</em>)</li>
<li><b>COMMAND</b> &ndash; The commands to be executed in series. Executable paths must be absolute. Execution will stop if one of them fails and the whole task will be considered failed. The whole task is considered finished (i.e. the <code>network-dhcp:wait</code> dependency is fulfilled) if the last command has successfully returned. If no <b>COMMAND</b> is given, the task is treated as a dependency group or "meta-task", see below. (<em>array-like</em>)</li>
<li><b>STOP_COMMAND</b> &ndash; Optional. Given commands are executed on <code>crinit-ctl stop &lt;TASKNAME&gt;</code>, <code>crinit-ctl poweroff</code> or <code>crinit-ctl reboot</code> instead of sending the regular <code>SIGTERM</code>. Same rules as for <b>COMMAND</b> apply. Additionally the variable "TASK_PID" can be used and will be expanded with the stored PID of the task. Example: <code>STOP_COMMAND = /usr/bin/kill ${TASK_PID}</code>. Please note that TASK_PID will expand to "-1" if the task is no longer running or has forked itself without notifying Crinit. <b>ATTENTION:</b> Currently <code>STOP_COMMAND</code> does not support <code>IO_REDIRECT</code>! Its output will not be redirected!</li>
<li><b>USER</b> &ndash; Name of the user used to run the commands specified in <b>COMMAND</b>. Either the username or the numeric user ID can be used. If <b>USER</b> is not set, "root" is assumed. <b>NOTE</b>: Changing user names, UIDs, group names or GIDs on the system while a task using them has already been loaded may result in undefined behaviour.</li>
<li><b>GROUP</b> &ndash; Name of the group used to run the commands specified in <b>COMMAND</b>. Either the group name or the numeric group ID can be used. If <b>GROUP</b> is not set, "root" is assumed. Note that setting supplementary groups is not yet supported. <b>Also see note on USER command.</b> This applies here, too.</li>
<li><b>DEPENDS</b> &ndash; A list of dependencies which need to be fulfilled before this task is considered "ready-to-start". Semantics are <code>&lt;taskname&gt;:{fail,wait,spawn}</code>, where <code>spawn</code> is fulfilled when (the first command of) a task has been started, <code>wait</code> if it has successfully completed, and <code>fail</code> if it has failed somewhere along the way. Here we can see this task is only run if and after the <code>earlysetup</code> (setup of system directories, etc.) has fully completed and the <code>check_qemu</code> task has determined we are <em>not</em> running inside the emulator and therefore exited with an error code. This may be left out or explicitly set to empty using <code>""</code> which is interpreted as "no dependencies". There is also the special <code>@provided:feature</code> syntax where we can define we want to depend on a specific feature another task may implement (see <b>PROVIDES</b>). In this case <code>@provided:writable_var</code> could mean that another task may have mounted a tmpfs or a writable partition there which we need for the first <code>mkdir</code>. That task would need to advertise the <code>writable_var</code> feature in its <code>PROVIDES</code> config value. (<em>array-like</em>) Additionally there is an optional feature that allows tasks to be started based on system events issued by elos. Tasks depending on an elos event can use the <code>@elos:&lt;filter_name&gt;</code> syntax to specify a task dependency that is fullfilled as soon as the specified elos filter triggers. The filters themself can be specified using the <b>FILTER_DEFINE</b> keyword.</li>
<li><b>PROVIDES</b> &ndash; As we have seen above, a task may depend on features and also provide them. In this case we advertise that after completion of this task (<code>wait</code>), the features <code>ipv4_dhcp</code> and <code>resolvconf</code> are provided. Another task may then depend e.g. on <code>@provided:resolvconf</code>. While the feature names chosen here reflect the functional intention, they can be chosen arbitrarily. (<em>array-like</em>)</li>
<li><b>RESPAWN</b> &ndash; If set to <code>YES</code>, the task will be restarted on failure or completion. Useful for daemons like <code>getty</code>. Default: <code>NO</code></li>
<li><b>RESPAWN_RETRIES</b> &ndash; Number of times a respawned task may fail <em>in a row</em> before it is not started again. The special value <code>-1</code> is interpreted as "unlimited". Default: -1</li>
<li><b>ENV_SET</b> &ndash; See section <b>Setting Environment Variables</b> below. (<em>array-like</em>)</li>
<li><b>FILTER_DEFINE</b> &ndash; See section <b>Defining Elos Filters</b> below. (<em>array-like</em>)</li>
<li><b>IO_REDIRECT</b> &ndash; See section <b>IO Redirections</b> below. (<em>array-like</em>)</li>
</ul>
<h2><a class="anchor" id="setting-environment-variables"></a>
Setting Environment Variables</h2>
<p>Crinit supports setting environment variables in the global and task configurations as shown above. The variables in the global config are valid for all tasks and may be locally overriden or referenced. The above examples together would result in the following list of environment variables for the task <code>network-dhcp</code> (with explanatory comments).</p>
<div class="fragment"><div class="line">FOO=foo</div>
<div class="line">FOO_BAZ=foo baz                            # Expansion of variable set before in the same config.</div>
<div class="line">FOO_BAR=foo bar                            # Expansion of global variable in task-local variable.</div>
<div class="line">GREETING=Good evening!                     # Override of global variable.</div>
<div class="line">ESCAPED_VAR=Global variable name: ${FOO}   # Avoid variable expansion through escaping.</div>
<div class="line">VAR_WITH_ESC_SEQUENCES=hex  hex            # Support for escape sequences including hexadecimal bytes.</div>
</div><!-- fragment --><h2><a class="anchor" id="defining-elos-filters"></a>
Defining Elos Filters</h2>
<p>Crinit supports an optional feature, which enables a task to depend on specific system events issued by the elos event logger. This needs ELOS support included at build-time.</p>
<p>In order to depend on elos events, a task uses the <code>@elos</code> dependency prefix in conjunction with a elos filter name. The corresponding filter has to be defined within the task itself or within the global environment. The definition follows the syntax of normal environment variables, but uses the <code>FILTER_DEFINE</code> prefix instead:</p>
<div class="fragment"><div class="line">FILTER_DEFINE = &lt;filter_name&gt; &lt;filter_rule&gt;</div>
</div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">NAME = elos_ssh_event_task</div>
<div class="line">COMMAND = /bin/echo &quot;Event task has been run.&quot;</div>
<div class="line"> </div>
<div class="line">FILTER_DEFINE = SSHD_FILTER &quot;.event.source.appName &#39;sshd&#39; STRCMP&quot;</div>
<div class="line"> </div>
<div class="line">DEPENDS = @elos:SSHD_FILTER</div>
</div><!-- fragment --><h3><a class="anchor" id="ruleset"></a>
Ruleset</h3>
<ul>
<li>A configuration file may have an unlimited number of <code>ENV_SET</code> statements, each specifying a single environment variable.</li>
<li><code>ENV_SET</code> statements must be of the form <code>ENV_SET = VARIABLE_NAME "variable content"</code>. The quotes around the variable content are mandatory and will not appear in the environment variable itself.</li>
<li>Setting the same variable twice overrides the first instance.</li>
<li>Variables can be referenced/expanded using shell-like <code>${VARIABLE_NAME}</code> syntax.<ul>
<li>Expansion can be avoided by escaping with a <code>\</code>.</li>
</ul>
</li>
<li>Variables can reference all other variables set before it, globally and locally.</li>
<li>Variables are set/processed in the order they appear in the config file.</li>
<li>Common escape sequences are supported: <code>\a, \b, \n, \t, \$, \\, \x&lt;two digit hex number&gt;</code>.</li>
</ul>
<h2><a class="anchor" id="include-files"></a>
Include files</h2>
<p>A crinit task configuration may reference multiple include files at any point in the task file. The effect is the same as manually copying the contents of the include file at exactly that point in the task config, similar to C includes. Additionally, it is possible to define an import list if not all settings in the include file should be applied.</p>
<p>An INCLUDE statement looks like </p><div class="fragment"><div class="line">INCLUDE = &lt;include_name&gt; [list,of,imported,settings]</div>
</div><!-- fragment --><p> where <code>&lt;include_name&gt;</code> is the filename of the include without the ending and without the leading path. The imported settings are defined as a comma-separated list of possible configuration options. If omitted, everything in the include file is taken.</p>
<p>Currently only <code>IO_REDIRECT</code>, <code>DEPENDS</code>, and <code>ENV_SET</code> are supported in include files.</p>
<p>Example: </p><div class="fragment"><div class="line">INCLUDE = server_settings ENV_SET,IO_REDIRECT</div>
</div><!-- fragment --><p> Imports only the <code>ENV_SET</code> and <code>IO_REDIRECT</code> settings from (assuming default values for include dir and suffix) <code>/etc/crinit/server_settings.crincl</code>.</p>
<p><code>server_settings.crincl</code> could look like </p><div class="fragment"><div class="line">ENV_SET = HTTP_PORT &quot;8080&quot;</div>
<div class="line">IO_REDIRECT = STDOUT /some/file.txt</div>
<div class="line">IO_REDIRECT = STDERR STDOUT</div>
<div class="line">DEPENDS = @provided:network</div>
</div><!-- fragment --><p> In the above case, the DEPENDS setting would be ignored.</p>
<h2><a class="anchor" id="io-redirections"></a>
IO Redirections</h2>
<p>Crinit supports per-task IO redirection to/from file and between STDOUT/IN/ERR using <code>IO_REDIRECT</code> statements in the task configurations. Please note that currently IO redirections do not work for STOP_COMMAND. The statements are of the form </p><div class="fragment"><div class="line">&lt;REDIRECT_FROM&gt; &lt;REDIRECT_TO&gt; [ APPEND | TRUNCATE | PIPE ] [ OCTAL_MODE ]</div>
</div><!-- fragment --><p> Where <code>REDIRECT_FROM</code> is one of <code>{ STDOUT, STDERR, STDIN }</code>, and <code>REDIRECT_TO</code> may either also be one of those streams or an absolute path to a file. <code>APPEND</code> or <code>TRUNCATE</code> signify whether an existing file at that location should be appended to or truncated. Default is <code>TRUNCATE</code>. The special value <code>PIPE</code> is discussed below (see <em>Named Pipes</em>). <code>OCTAL_MODE</code> sets the permission bits if the file is newly created. Default is <code>0644</code>.</p>
<p>Accordingly the statements in the example configuration above will result in <code>stdout</code> being redirected to the file <code>/var/log/net-dhcp.log</code> in append mode. If the file does not yet exist, it will be created with permission bits <code>0644</code>. The second statement then redirects stderr to stdout, capturing both in the log.</p>
<p>Other examples could be </p><div class="fragment"><div class="line">IO_REDIRECT = STDERR &quot;/var/log/err.log&quot; APPEND</div>
<div class="line">IO_REDIRECT = STDOUT &quot;/dev/null&quot;</div>
</div><!-- fragment --><p> to silence stdout and log stderr, or </p><div class="fragment"><div class="line">IO_REDIRECT = STDIN /opt/data/backup.tar</div>
<div class="line">IO_REDIRECT = STDOUT /opt/data/backup.tar.gz</div>
</div><!-- fragment --><p> to read stdin from file and capture stdout to another file. Stderr will go to console as normal.</p>
<h3><a class="anchor" id="named-pipes"></a>
Named pipes</h3>
<p>As indicated above, <code>crinit</code> also accepts the setting <code>PIPE</code> instead of <code>APPEND</code> or <code>TRUNCATE</code>. With this setting, <code>crinit</code> will ensure that the given path is a named pipe (also called a FIFO special file). This is useful to pipe the output of one task to another.</p>
<p>A common example would be redirection of output to syslog. For that we would create two task files, one as the sender and another as the receiver (using the <code>logger</code> utility provided by e.g. busybox and others).</p>
<p><b>Sending Task</b></p>
<div class="fragment"><div class="line">NAME = some_task</div>
<div class="line"> </div>
<div class="line">COMMAND = /bin/echo &quot;This output will be redirected to syslog!&quot;</div>
<div class="line">RESPAWN = NO</div>
<div class="line">DEPENDS = &quot;&quot;</div>
<div class="line"> </div>
<div class="line">IO_REDIRECT = STDOUT &quot;/tmp/some_task_log_pipe&quot; PIPE 0640</div>
</div><!-- fragment --><p><b>Receiving Task</b></p>
<div class="fragment"><div class="line">NAME = some_task_logger</div>
<div class="line"> </div>
<div class="line">COMMAND = /usr/bin/logger -t some_task</div>
<div class="line">RESPAWN = YES</div>
<div class="line">DEPENDS = &quot;&quot;</div>
<div class="line"> </div>
<div class="line">IO_REDIRECT = STDIN &quot;/tmp/some_task_log_pipe&quot; PIPE 0640</div>
</div><!-- fragment --><p>This will redirect the output of the <code>echo</code> command to the input of the <code>logger</code> utility and thereby to syslog. As is shown, it is also possible to set permissions for named pipes (default will also be <code>0644</code>). It should be kept in mind to keep the permissions the same in both tasks. Setting different permissions in the sending and receiving task of a pipe creates a race condition where one of the tasks will be able to create the named pipe with its settings. The other task will take it as-is, as long as it can access the file.</p>
<h3><a class="anchor" id="a-note-on-buffering"></a>
A note on buffering</h3>
<p>By default, glibc will switch from line- to block-buffered mode when redirecting a stream to file. This may make it hard to use e.g. <code>tail -f ...</code> to monitor the output in parallel. To get around that problem, one may use the <code>stdbuf</code> utility (part of GNU coreutils).</p>
<p>In a <code>crinit</code> task, the following </p><div class="fragment"><div class="line">NAME = line_buffered_task</div>
<div class="line"> </div>
<div class="line">COMMAND = /usr/bin/stdbuf -oL -eL &lt;SOME_EXECUTABLE&gt;</div>
<div class="line"> </div>
<div class="line">IO_REDIRECT = STDOUT &quot;/some/where.txt&quot;</div>
<div class="line">              STDERR &quot;/some/where/else.txt&quot;</div>
</div><!-- fragment --><p>will result in line-buffered output to the files which can be monitored easily. For more details, see the <code>stdbuf</code> man page.</p>
<h2><a class="anchor" id="dependency-groups-meta-tasks"></a>
Dependency groups (meta-tasks)</h2>
<p>A dependency group or meta-task is a task without any **COMMAND**s. The provided dependencies of the meta-task will be fulfilled immediately once its own dependencies are fulfilled. This can be used to semantically combine different dependencies into one. Reasons to do that can be semantic readability of the configs or to provide hook dependencies for third-party applications having an opaque view of their target system.</p>
<p>As an example a dependency group and a task using it could look like</p>
<div class="fragment"><div class="line">NAME = dep_grp_server</div>
<div class="line"> </div>
<div class="line">DEPENDS = @provided:sql-db @provided:network @provided:firewall-open-port httpd:spawn</div>
<div class="line"> </div>
<div class="line">PROVIDES = server:wait</div>
</div><!-- fragment --><div class="fragment"><div class="line">NAME = local_http_client</div>
<div class="line"> </div>
<div class="line">COMMAND = /usr/bin/some-http-request localhost</div>
<div class="line"> </div>
<div class="line">DEPENDS = @provided:server</div>
<div class="line"># or, with same effect: DEPENDS = dep_grp_server:wait</div>
</div><!-- fragment --><p>Semantically, this would mean <code>local_http_client</code> only cares about the server, as a singular entity, being set up and running. This could also be delivered by a third party with only the interface knowledge "You need to wait for the
`server` dependency". How to provide this dependency, with which tasks, and in what order is then up to the system integrator who maintains <code>dep_grp_server</code>.</p>
<h2><a class="anchor" id="configuration-signatures"></a>
Configuration Signatures</h2>
<p>If compiled in (see <a class="el" href="index.html#build-instructions">Build Instructions</a>), Crinit supports checking signatures of its task and global configuration files. The algorithm used is RSA-PSS using 4096 Bit keys and SHA256 hashing.</p>
<p>Crinit will use a root public key (named <code>crinit-root</code> as the searchable key description`) stored in the Kernel user keyring and optionally downstream signed public keys stored in the rootfs. The downstream keys need to be signed using the root key. Configuration files must then be signed either by the root key or by one of the downstream keys.</p>
<p>The root public key must be enrolled to the user keyring before Crinit starts. A common solution is to do this from a signed initramfs, thereby leveraging a secure boot chain to establish trust in the key.</p>
<p>Signature checking is configured via the Kernel command line (also part of the trusted/secure boot chain) using these two settings:</p>
<ul>
<li><code>crinit.signatures={yes, no}</code> - Activates signature checking if set to <code>yes</code>. Default is <code>no</code>.</li>
<li><code>crinit.sigkeydir=&lt;path_to_downstream_keys&gt;</code> - Sets the path where Crinit searches for signed public keys in the rootfs. Default is <code>/etc/crinit/pk</code>.</li>
</ul>
<p>For downstream keys and configuration files, Crinit expects a corresponding signature file with the <code>.sig</code> suffix to be present in the same directory. As an example, the task file <code>very_valid.task</code> would need a signature file <code>very_valid.task.sig</code> next to it. Key files may be in DER and PEM format with the appropriate filename extensions. The <code>crinit-root</code> public key stored in the user keyring should be in DER binary format.</p>
<p>To prepare a system for using signatures and correctly signing files, the <code>scripts</code> directory contains</p>
<ul>
<li><b>crinit-genkeys.sh</b> to generate private signing keys and their public key counterparts. <div class="fragment"><div class="line">Usage: ./crinit-genkeys.sh [-h/--help] [-k/--key-file &lt;KEY_FILE&gt;] [-o/--output &lt;OUTPUT_FILE&gt;]</div>
<div class="line">  If no other arguments are given, will generate an RSA-4096 private key. Alternatively using &#39;-k&#39;, you can obtain</div>
<div class="line">  the public key for the given private key.</div>
<div class="line">    -h/--help</div>
<div class="line">        - Show this help.</div>
<div class="line">    -f/--format</div>
<div class="line">        - Choose the format of the output file. Must be either &#39;pem&#39; or &#39;der&#39;. Default: &#39;pem&#39;</div>
<div class="line">    -k/--key-file &lt;KEY_FILE&gt;</div>
<div class="line">        - Generate a public key from the given private key. Use &#39;-&#39; for Standard Input. Default: Generate a private key.</div>
<div class="line">    -o/--output &lt;OUTPUT_FILE&gt;</div>
<div class="line">        - The filename of the output key. Default: write to Standard Output</div>
</div><!-- fragment --></li>
<li><b>crinit-sign.sh</b> to sign files with a given private key. <div class="fragment"><div class="line">Usage: ./crinit-sign.sh [-h/--help] [-k/--key-file &lt;KEY_FILE&gt;] [-o/--output &lt;OUTPUT_FILE&gt;] [&lt;INPUT_FILE&gt;]</div>
<div class="line">  Will sign given input data with an RSA-PSS signature from an RSA-4096 private key using a SHA-256 hash.</div>
<div class="line">    -h/--help</div>
<div class="line">        - Show this help.</div>
<div class="line">    -k/--key-file &lt;KEY_FILE&gt;</div>
<div class="line">        - Use the given private key to sign. Must have been created using crinit-genkeys.sh. (Mandatory)</div>
<div class="line">    -o/--output &lt;OUTPUT_FILE&gt;</div>
<div class="line">        - Write signature to OUTPUT_FILE. Default: Standard Output</div>
<div class="line">    &lt;INPUT_FILE&gt;</div>
<div class="line">        - Positional argument. The input data to sign. Default: Standard Input</div>
</div><!-- fragment --> Step by step instruction for a system with a root key and one downstream key would be:</li>
</ul>
<ol type="1">
<li><code>$ crinit-genkeys.sh -o crinit-root-priv.pem # generate private root key</code></li>
<li><code>$ crinit-genkeys.sh -f der -k crinit-root-pub.der # calculate public root key from it (destined for user keyring)</code></li>
<li><code>$ crinit-genkeys.sh -o crinit-dwstr-priv.pem # generate downstream key</code></li>
<li><code>$ crinit-genkeys.sh -k crinit-root-pub.pem # calculate public key from it (destined for rootfs)</code></li>
<li><code>$ crinit-sign.sh -k crinit-root-priv.pem -o crinit-dwstr-pub.pem.sig crinit-dwstr-pub.pem # sign downstream key with root key</code></li>
<li>Do step 5 for all configuration files crinit is expected to parse using either the root or the downstream key.</li>
</ol>
<h1><a class="anchor" id="crinit-ctl-usage-info"></a>
crinit-ctl Usage Info</h1>
<p><code>crinit-ctl</code> is a CLI control program for <code>crinit</code> wrapping the client API functionality.</p>
<p>Below is its help output: </p><div class="fragment"><div class="line">USAGE: crinit-ctl &lt;ACTION&gt; [OPTIONS] &lt;PARAMETER&gt; [PARAMETERS...]</div>
<div class="line">  where ACTION must be exactly one of (including specific options/parameters):</div>
<div class="line">     addtask [-f/--overwrite] [-i/--ignore-deps] [-d/--override-deps &quot;depA:eventA depB:eventB [...]&quot;] &lt;PATH&gt;</div>
<div class="line">             - Will add a task defined in the task configuration file at &lt;PATH&gt; (absolute) to Crinit&#39;s task database.</div>
<div class="line">               &#39;-f/--overwrite&#39; - Lets Crinit know it is fine to overwrite if it has already loaded a task</div>
<div class="line">                    with the same name.</div>
<div class="line">               &#39;-d/--override-deps &lt;dependency-list&gt;&#39; - Will override the DEPENDS field of the config file</div>
<div class="line">                    with what is given as the parameter.</div>
<div class="line">               &#39;-i/--ignore-deps&#39; - Shortcut for &#39;--override-deps &quot;&quot;&#39;.</div>
<div class="line">   addseries [-f/--overwrite] &lt;PATH&gt;</div>
<div class="line">             - Will load a series file from &lt;PATH&gt;. Options set in the new series file take precedence over</div>
<div class="line">               current settings.</div>
<div class="line">               &#39;-f/--overwrite&#39; - Lets Crinit know it is fine to overwrite if it has already loaded tasks</div>
<div class="line">                    with the same name as those in the new series file.</div>
<div class="line">      enable &lt;TASK_NAME&gt;</div>
<div class="line">             - Removes dependency &#39;@ctl:enable&#39; from the dependency list of &lt;TASK_NAME&gt; if it is present.</div>
<div class="line">     disable &lt;TASK_NAME&gt;</div>
<div class="line">             - Adds dependency &#39;@ctl:enable&#39; to the dependency list of &lt;TASK_NAME&gt;.</div>
<div class="line">        stop &lt;TASK_NAME&gt;</div>
<div class="line">             - If the task has a STOP_COMMAND, it will be executed. Otherwise, Crinit sends SIGTERM to the</div>
<div class="line">               PID of &lt;TASK_NAME&gt; if the PID is currently known.</div>
<div class="line">        kill &lt;TASK_NAME&gt;</div>
<div class="line">             - Sends SIGKILL to the PID of &lt;TASK_NAME&gt; if the PID is currently known.</div>
<div class="line">     restart &lt;TASK_NAME&gt;</div>
<div class="line">             - Resets the status bits of &lt;TASK_NAME&gt; if it is DONE or FAILED.</div>
<div class="line">      status &lt;TASK_NAME&gt;</div>
<div class="line">             - Queries status bits, PID, and timestamps of &lt;TASK_NAME&gt;. The CTime, STime, and ETime fields</div>
<div class="line">               represent the times the task was Created (loaded/parsed), last Started (became running), and</div>
<div class="line">               last Ended (failed or is done). If the event has not occurred yet, the timestamp&#39;s value will</div>
<div class="line">               be &#39;n/a&#39;.</div>
<div class="line">      notify &lt;TASK_NAME&gt; &lt;&quot;SD_NOTIFY_STRING&quot;&gt;</div>
<div class="line">             - Will send an sd_notify-style status report to Crinit. Only MAINPID and READY are</div>
<div class="line">               implemented. See the sd_notify documentation for their meaning.</div>
<div class="line">        list</div>
<div class="line">             - Print the list of loaded tasks and their status.</div>
<div class="line">      reboot</div>
<div class="line">             - Will request Crinit to perform a graceful system reboot. crinit-ctl can be symlinked to</div>
<div class="line">               reboot as a shortcut which will invoke this command automatically.</div>
<div class="line">    poweroff</div>
<div class="line">             - Will request Crinit to perform a graceful system shutdown. crinit-ctl can be symlinked to</div>
<div class="line">               poweroff as a shortcut which will invoke this command automatically.</div>
<div class="line">  General Options:</div>
<div class="line">        --verbose/-v - Be verbose.</div>
<div class="line">        --help/-h    - Print this help.</div>
<div class="line">        --version/-V - Print version information about crinit-ctl, the crinit-client library,</div>
<div class="line">                       and -- if connection is successful -- the crinit daemon.</div>
</div><!-- fragment --><p>As noted above, it will also make use of the <code>CRINIT_SOCK</code> environment variable to know which crinit socket to connect to (Default: <code>/run/crinit/crinit.sock</code>).</p>
<h1><a class="anchor" id="smart-bash-completion-for-crinit-ctl"></a>
Smart bash completion for crinit-ctl</h1>
<p>There is a script to support smart bash completions for the crinit-ctl executable located at <code>completion/crinit-ctl.bash</code>. On modern distributions, this file will need to be copied and renamed to <code>/usr/share/bash-completion/completions/crinit-ctl</code> to be picked up automatically. The <code>cmake</code> installer can do this (see below). Note that a fully bash-compatible shell (<code>bash</code>,<code>dash</code>) is required to take advantage of this.</p>
<p>For testing purposes, it is sufficient to run <code>source completion/crinit-ctl.bash</code> to activate the smart completion for the current session. The script can also be sourced from <code>.bashrc</code> if a system-wide installation is not desired.</p>
<p>Once installed and loaded, <code>crinit-ctl &lt;TAB&gt;&lt;TAB&gt;</code> will show/complete available command verbs like <code>addtask</code>, <code>enable</code>, <code>disable</code>, etc. For <code>crinit-ctl addtask &lt;TAB&gt;&lt;TAB&gt;</code>, paths to <code>\*.crinit</code> files and specific options will be completed, similar for <code>addseries</code>. Verbs taking a task name as input will have completion of available tasks loaded by crinit. The script calls <code>crinit-ctl list</code> and parses its output in the background to achieve this.</p>
<h1><a class="anchor" id="crinit-launch"></a>
crinit-launch</h1>
<p>The <code>crinit-launch</code> executable is a helper program to start a command as a different user and / or group. It is not meant to be executed by the user directly.</p>
<h1><a class="anchor" id="build-instructions"></a>
Build Instructions</h1>
<p>Executing </p><div class="fragment"><div class="line">ci/docker-run.sh</div>
</div><!-- fragment --><p> will start a Docker container for the native host architecture with all necessary programs to build Crinit and its Doxygen documentation and to run the tests.</p>
<p>It is possible to run the Docker container for a foreign architecture such as arm64 with the help of qemu-user-static and binfmt-support. Make sure these packages are installed on your host system if you want to use this functionality. All following commands to be run inside the container will be the same regardless of the architecture. </p><div class="fragment"><div class="line">ci/docker-run.sh arm64</div>
</div><!-- fragment --><p>By default, <code>ci/docker-run.sh</code> will use a container based on Ubuntu Jammy. If another version is desired, it can be specified as a second parameter. For example, you can run a Lunar-based container using </p><div class="fragment"><div class="line">ci/docker-run.sh amd64 lunar</div>
</div><!-- fragment --><p>Inside the container, it is sufficient to run </p><div class="fragment"><div class="line">ci/build.sh</div>
</div><!-- fragment --><p> which will compile the release configuration for <code>crinit</code>, the client library and crinit-ctl as well as a suite of RPMs. The doxygen documentation is built as well. The script will copy relevant build artifacts to <code>result/</code>.</p>
<p>For debugging purposes, the debug configuration can be built with the following command. Optionally it is also possible to enable AddressSanitizer (ASAN) for additional runtime checks or static analysis using <code>-fanalyzer</code> at compile-time. </p><div class="fragment"><div class="line">ci/build.sh Debug --asan --analyzer</div>
</div><!-- fragment --><p>A <code>clang-tidy</code> analysis of the source can be performed using </p><div class="fragment"><div class="line">ci/clang-tidy.sh</div>
</div><!-- fragment --><p> This will also generate a <code>compile_commands.json</code>. The output will be saved to <code>result/clang-tidy</code>.</p>
<p>Unit tests or smoke tests can be run using the respective commands below. For the debug configuration, either of them takes an additional <code>Debug</code> argument. </p><div class="fragment"><div class="line">ci/run-utest.sh</div>
<div class="line">ci/run-smoketests.sh</div>
</div><!-- fragment --><p>In order to run integration tests, you can use <code>ci/run-integration-tests.sh</code>. This will set up two docker containers, one for the Robot test framework and one that runs Crinit and Elos, and executes all integration tests inside the robot container.</p>
<div class="fragment"><div class="line">ci/run-integration-tests.sh</div>
</div><!-- fragment --><p>You can also manually start both containers with <code>ci/docker-target-run.sh</code> and <code>ci/docker-integration-run.sh</code>. Adapt the configuration within the robot container by changing the ip address of the target container within the robot variables (<code>test/integration/robot_variables.py</code>) to the current ip of the target container and run the tests by executing <code>test/integration/scripts/run-integration-tests.sh</code> inside the robot container.</p>
<p>If a manual test build is desired, running the following command sequence inside the container will setup the build system and build native binaries. </p><div class="fragment"><div class="line">mkdir -p build/amd64</div>
<div class="line">cmake -B build/amd64 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=On -DUNIT_TESTS=On</div>
<div class="line">make -C build/amd64</div>
</div><!-- fragment --><p>Some default paths can be configured on compile time:</p><ul>
<li>Default series file: <code>-DDEFAULT_CONFIG_SERIES_FILE</code>. Default is <code>$CMAKE_INSTALL_SYSCONFDIR/crinit/default.series</code>.</li>
<li>Default location of the client communication socket: <code>-DDEFAULT_CRINIT_SOCKFILE=&lt;FILEPATH&gt;</code>. Default is <code>$CMAKE_INSTALL_RUNSTATEDIR/crinit/crinit.sock</code>.</li>
<li>Default include directory: <code>-DDEFAULT_INCL_DIR=&lt;PATH&gt;</code>. Default is <code>$CMAKE_INSTALL_SYSCONFDIR/crinit</code>.</li>
<li>Default task directory: <code>-DDEFAULT_TASK_DIR=&lt;PATH&gt;</code>. Default is <code>$CMAKE_INSTALL_SYSCONFDIR/crinit</code>.</li>
</ul>
<p>The cmake setup supports some optional features:</p><ul>
<li>Crinit signature support using <code>-DENABLE_SIGNATURE_SUPPORT={On, Off}</code>. If set to on, crinit will have a dependency to <a href="https://github.com/Mbed-TLS/mbedtls">libmbedtls</a>. Default is <code>On</code>.</li>
<li>Configurable default path of signed (downstream) public keys <code>-DDEFAULT_SIGKEY_DIR=&lt;PATH&gt;</code>. Default is <code>$CMAKE_INSTALL_SYSCONFDIR/crinit/pk</code>.</li>
<li>Crinit ELOS support using <code>-DENABLE_ELOS={On, Off}</code>. If set to on, crinit will have a dependency to <a href="https://github.com/elektrobit/safu">safu</a>. Default is <code>On</code>.</li>
<li>Unit tests using <code>-DUNIT_TESTS={On, Off}</code>. If set to on, Crinit's unit tests will be built and installed to <code>UNIT_TEST_INSTALL_DIR</code>. This will cause a dependency to cmocka 1.1.5 or greater. Default is <code>On</code> with installation path <code>${CMAKE_INSTALL_LIBDIR}/test/crinit/utest</code>.</li>
<li>Elos event polling time (see global configuration example) <code>-DDEFAULT_ELOS_EVENT_POLLING_TIME=&lt;usecs&gt;</code>. Default is 500000.</li>
<li>Build and install API documentation in doxygen HTML format using <code>-DAPI_DOC={On, Off}</code>. Needs doxygen. Default is <code>On</code>.</li>
<li>Build and install an example generator for the machine id file (see above) using <code>-DMACHINE_ID_EXAMPLE={On, Off}</code>. Default is <code>Off</code>.</li>
<li>Name and path for the machine id file: <code>-DDEFAULT_MACHINE_ID_FILE=&lt;FILEPATH&gt;</code>. Default is <code>$CMAKE_INSTALL_SYSCONFDIR/machine-id</code>.</li>
<li>Install the example configurations from <code>config/example</code> to <code>/etc/${EXAMPLE_TASKDIR}</code>. Default is <code>Off</code>, default installation path is <code>/etc/crinit/example</code>.</li>
<li>Install the smoke test scripts and configurations, using <code>-DINSTALL_SMOKE_TESTS={On, Off}</code>, to the <code>SMOKE_TEST_SCRIPT_DIR</code> and <code>SMOKE_TEST_CONF_DIR</code>, respectively. Default is <code>Off</code> and default installation paths are <code>${CMAKE_INSTALL_LIBDIR}/test/crinit/smoketest</code> and <code>${CMAKE_INSTALL_LIBDIR}/test/crinit/smoketest/config</code>.</li>
<li>Install the necessary resources for a robot test target system using <code>-DINSTALL_ROBOT_TEST_RESOURCES={On, Off}</code> to <code>ROBOT_TEST_RESOURCE_DIR</code>. Default is <code>Off</code> and default install path is <code>${CMAKE_INSTALL_SYSCONFDIR}/crinit/itest</code>.</li>
<li>Set the installation path for the symbolic links for <code>reboot</code> and <code>poweroff</code> using <code>PWR_SYMLINKS_PATH</code>. Default is <code>${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_SBINDIR}</code></li>
<li>Install the bash completion script for crinit-ctl, using <code>-DINSTALL_BASH_COMPLETION={On, Off}</code>, to the <code>BASH_COMPLETION_DIR</code>. Default is <code>On</code> and default isntall path is <code>${CMAKE_INSTALL_DATADIR/bash-completion/completions</code>.</li>
<li>Set the <code>SONAME</code> of libelos crinit will try to open at run-time. Default is auto-detection if elos is present in the build environment or <code>libelos.so.1</code> if it is not.</li>
</ul>
<h1><a class="anchor" id="build-requirements"></a>
Build Requirements</h1>
<p>In order to build crinit, some prerequisites have to be installed.</p>
<ul>
<li>a modern GCC toolchain with C17 support</li>
<li>cmake &gt;= 3.21</li>
<li>re2c &gt;= 3.0</li>
<li>optional, for ELOS support: <a href="https://github.com/elektrobit/safu">safu</a> &gt;= 0.58.2</li>
<li>optional, for signature support: <a href="https://github.com/Mbed-TLS/mbedtls">MbedTLS</a> 2.28.x or 3.x</li>
<li>optional, for unit tests: cmocka &gt;= 1.1.5</li>
<li>optional, for HTML API documentation: Doxygen </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
